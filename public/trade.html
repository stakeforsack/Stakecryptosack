<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trade | CryptoYieldPro</title>

  <!-- Global CSS (keep your existing) -->
  <link rel="stylesheet" href="/style.css" />
  <!-- Inter font for consistency -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-1: #06060a;
      --bg-2: #0b0b12;
      --card: rgba(255,255,255,0.02);
      --card-border: rgba(255,255,255,0.04);
      --muted: #9aa3b2;
      --accent: #a855f7;
      --accent-soft: rgba(168,85,247,0.22);
      --accent2: #5eead4;
      --danger: #ff6b6b;
      --success: #7ef6b8;
      --radius: 16px;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 800px at 0% 0%, rgba(168,85,247,0.08), transparent 40%),
        radial-gradient(900px 700px at 100% 100%, rgba(94,234,212,0.06), transparent 40%),
        linear-gradient(180deg, var(--bg-1), var(--bg-2));
      color: #f9fbff;
      -webkit-font-smoothing: antialiased;
      padding-bottom: 70px; /* bottom nav space */
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px 16px 24px;
    }

    /* Header */
    .trade-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }
    .trade-title {
      font-size: 1.25rem;
      font-weight: 800;
      letter-spacing: 0.4px;
    }
    .trade-sub {
      font-size: 0.85rem;
      color: var(--muted);
    }
    .pill {
      font-size: 0.8rem;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.3);
      color: var(--muted);
    }

    /* Coin list */
    .coins {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .coin-card {
      position: relative;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.035);
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
      box-shadow: 0 8px 25px rgba(0,0,0,0.6);
    }

    .coin-card::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(circle at top, rgba(168,85,247,0.12), transparent 60%);
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
    }

    .coin-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 18px 40px rgba(0,0,0,0.8);
      border-color: rgba(168,85,247,0.5);
    }

    .coin-card.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(168,85,247,0.5), 0 16px 36px rgba(0,0,0,0.9);
    }

    .coin-card.active::after {
      opacity: 1;
    }

    .coin-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,255,0.2), transparent 70%);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .coin-icon img {
      width: 24px;
      height: 24px;
      display: block;
    }

    .coin-meta {
      flex: 1;
      min-width: 0;
    }

    .coin-name {
      font-size: 0.9rem;
      font-weight: 700;
    }

    .coin-symbol {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .coin-price {
      font-weight: 700;
      font-size: 0.95rem;
      margin-top: 4px;
    }

    .coin-change {
      font-size: 0.8rem;
      margin-top: 2px;
    }
    .coin-change.pos { color: var(--success); }
    .coin-change.neg { color: var(--danger); }

    /* Chart container */
    .chart-shell {
      margin-top: 4px;
      background: linear-gradient(160deg, rgba(10,10,16,1), rgba(5,5,10,1));
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.05);
      padding: 12px 12px 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.9);
    }

    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
    }

    .chart-title-block {
      min-width: 0;
    }

    .chart-title {
      margin: 0;
      font-size: 0.95rem;
      font-weight: 700;
    }

    .chart-sub {
      margin: 2px 0 0;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .chart-stats {
      font-size: 0.8rem;
      text-align: right;
    }

    .chart-stats span {
      display: block;
    }

    .chart-change-pos { color: var(--success); }
    .chart-change-neg { color: var(--danger); }

    /* Timeframe buttons */
    .tf-buttons {
      display: flex;
      gap: 4px;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: 4px;
    }

    .tf-btn {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.06);
      padding: 4px 10px;
      font-size: 0.75rem;
      background: rgba(10,10,16,0.9);
      color: var(--muted);
      cursor: pointer;
      transition: background 0.18s, color 0.18s, border-color 0.18s;
    }

    .tf-btn.active {
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color: #031011;
      border-color: transparent;
      font-weight: 700;
    }

    /* Chart canvas */
    .chart-canvas-wrap {
      position: relative;
      width: 100%;
      height: 260px; /* fixed, prevents growing bug */
    }

    #priceChart {
      width: 100% !important;
      height: 100% !important;
      display: block;
    }

    .chart-loader {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: var(--muted);
      background: radial-gradient(circle at center, rgba(0,0,0,0.6), transparent 70%);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .chart-loader.show {
      opacity: 1;
    }

    /* Bottom nav (match home theme) */
    .bottom-nav {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      padding: 8px 16px;
      display: flex;
      gap: 14px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.9);
      backdrop-filter: blur(18px);
      z-index: 100;
    }

    .nav-item {
      text-decoration: none;
      color: var(--muted);
      font-size: 0.75rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 4px 6px;
      transition: transform 0.15s, color 0.15s;
    }

    .nav-item img {
      width: 20px;
      height: 20px;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.7));
    }

    .nav-item.active {
      color: var(--accent);
      transform: translateY(-3px);
    }

    .nav-item:hover {
      transform: translateY(-2px);
      color: var(--accent2);
    }

    @media (max-width: 600px) {
      .wrap {
        padding: 12px 12px 24px;
      }
      .coin-card {
        padding: 10px;
      }
      .chart-canvas-wrap {
        height: 230px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="trade-header">
      <div>
        <div class="trade-title">Markets & Live Chart</div>
        <div class="trade-sub">Tap a coin to view its live chart & price action.</div>
      </div>
      <div class="pill">Live feed · 10s refresh</div>
    </header>

    <!-- Coin list -->
    <section class="coins" id="coinsList">
      <!-- BTC -->
      <article class="coin-card active" data-coin="bitcoin" data-symbol="BTC">
        <div class="coin-icon">
          <img src="/img/btc.png" alt="BTC">
        </div>
        <div class="coin-meta">
          <div class="coin-name">Bitcoin</div>
          <div class="coin-symbol">BTC / USDT</div>
          <div class="coin-price" data-price-id="bitcoin">—</div>
          <div class="coin-change" data-change-id="bitcoin">—</div>
        </div>
      </article>

      <!-- ETH -->
      <article class="coin-card" data-coin="ethereum" data-symbol="ETH">
        <div class="coin-icon">
          <img src="/img/eth.png" alt="ETH">
        </div>
        <div class="coin-meta">
          <div class="coin-name">Ethereum</div>
          <div class="coin-symbol">ETH / USDT</div>
          <div class="coin-price" data-price-id="ethereum">—</div>
          <div class="coin-change" data-change-id="ethereum">—</div>
        </div>
      </article>

      <!-- USDT -->
      <article class="coin-card" data-coin="tether" data-symbol="USDT">
        <div class="coin-icon">
          <img src="/img/usdt.png" alt="USDT">
        </div>
        <div class="coin-meta">
          <div class="coin-name">Tether</div>
          <div class="coin-symbol">USDT</div>
          <div class="coin-price" data-price-id="tether">—</div>
          <div class="coin-change" data-change-id="tether">—</div>
        </div>
      </article>

      <!-- ADA -->
      <article class="coin-card" data-coin="cardano" data-symbol="ADA">
        <div class="coin-icon">
          <img src="/img/ada.png" alt="ADA">
        </div>
        <div class="coin-meta">
          <div class="coin-name">Cardano</div>
          <div class="coin-symbol">ADA / USDT</div>
          <div class="coin-price" data-price-id="cardano">—</div>
          <div class="coin-change" data-change-id="cardano">—</div>
        </div>
      </article>

      <!-- BNB -->
      <article class="coin-card" data-coin="binancecoin" data-symbol="BNB">
        <div class="coin-icon">
          <img src="/img/bnb.png" alt="BNB">
        </div>
        <div class="coin-meta">
          <div class="coin-name">Binance Coin</div>
          <div class="coin-symbol">BNB / USDT</div>
          <div class="coin-price" data-price-id="binancecoin">—</div>
          <div class="coin-change" data-change-id="binancecoin">—</div>
        </div>
      </article>

      <!-- SOL -->
      <article class="coin-card" data-coin="solana" data-symbol="SOL">
        <div class="coin-icon">
          <img src="/img/sol.png" alt="SOL">
        </div>
        <div class="coin-meta">
          <div class="coin-name">Solana</div>
          <div class="coin-symbol">SOL / USDT</div>
          <div class="coin-price" data-price-id="solana">—</div>
          <div class="coin-change" data-change-id="solana">—</div>
        </div>
      </article>
    </section>

    <!-- Chart area (single global chart) -->
    <section class="chart-shell" aria-label="Live price chart">
      <div class="chart-header">
        <div class="chart-title-block">
          <h2 class="chart-title" id="chartTitle">Bitcoin (BTC)</h2>
          <p class="chart-sub" id="chartSubtitle">Live price, updated from CoinGecko</p>
        </div>
        <div class="chart-stats">
          <span id="chartLastPrice">Current: —</span>
          <span id="chartChange" class="">24h: —</span>
        </div>
      </div>

      <div class="tf-buttons">
        <button class="tf-btn active" data-period="1h">1H</button>
        <button class="tf-btn" data-period="6h">6H</button>
        <button class="tf-btn" data-period="1d">1D</button>
      </div>

      <div class="chart-canvas-wrap">
        <canvas id="priceChart"></canvas>
        <div class="chart-loader" id="chartLoader">Loading chart...</div>
      </div>
    </section>
  </div>

  <!-- Bottom nav -->
  <nav class="bottom-nav">
    <a class="nav-item" href="home.html">
      <img src="/img/house.png" alt="Home" />
      <span>Home</span>
    </a>
    <a class="nav-item active" href="trade.html">
      <img src="/img/trade.png" alt="Trade" />
      <span>Trade</span>
    </a>
    <a class="nav-item" href="internal-transfer.html">
      <img src="/img/transfer.png" alt="Transfer" />
      <span>Transfer</span>
    </a>
    <a class="nav-item" href="account.html">
      <img src="/img/myaccount.png" alt="Account" />
      <span>Account</span>
    </a>
  </nav>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Your existing price updater (for cards) -->
  <script src="/js/market-prices.js"></script>

  <script>
    // Start your existing live price system
    document.addEventListener('DOMContentLoaded', () => {
      try {
        MarketPrices.start(
          ['bitcoin','ethereum','tether','cardano','binancecoin','solana'],
          10000
        );
      } catch (e) {
        console.warn('MarketPrices not available or error', e);
      }
    });
  </script>

  <!-- Live chart logic (CoinGecko) -->
  <script>
    const COINGECKO_BASE = 'https://api.coingecko.com/api/v3';
    let chartInstance = null;
    let currentCoin = 'bitcoin';
    let currentSymbol = 'BTC';
    let currentPeriod = '1h';

    const chartTitleEl = document.getElementById('chartTitle');
    const chartSubtitleEl = document.getElementById('chartSubtitle');
    const chartLastPriceEl = document.getElementById('chartLastPrice');
    const chartChangeEl = document.getElementById('chartChange');
    const chartLoader = document.getElementById('chartLoader');
    const ctx = document.getElementById('priceChart').getContext('2d');

    function showLoader(show) {
      if (show) chartLoader.classList.add('show');
      else chartLoader.classList.remove('show');
    }

    function setActiveCoinCard(coinId) {
      document.querySelectorAll('.coin-card').forEach(card => {
        card.classList.toggle('active', card.dataset.coin === coinId);
      });
    }

    function setActivePeriodButton(period) {
      document.querySelectorAll('.tf-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.period === period);
      });
    }

    function periodToHours(period) {
      if (period === '1h') return 1;
      if (period === '6h') return 6;
      return 24; // 1d
    }

    async function fetchHistory(coinId, period) {
      const hours = periodToHours(period);
      // we'll fetch 1 day and slice locally for smaller windows
      const url = `${COINGECKO_BASE}/coins/${coinId}/market_chart?vs_currency=usd&days=1&interval=minute`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Failed to load chart data');
      const data = await res.json();
      const now = Date.now();
      const cutoff = now - hours * 60 * 60 * 1000;

      const prices = (data.prices || []).filter(([ts]) => ts >= cutoff);
      return prices;
    }

    async function fetchCurrent(coinId) {
      const url = `${COINGECKO_BASE}/simple/price?ids=${coinId}&vs_currencies=usd&include_24hr_change=true`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Failed to load current price');
      const json = await res.json();
      const entry = json[coinId];
      return {
        price: entry?.usd ?? null,
        change: entry?.usd_24h_change ?? null
      };
    }

    function createOrUpdateChart(labels, values) {
      const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
      gradient.addColorStop(0, 'rgba(168,85,247,0.4)');
      gradient.addColorStop(1, 'rgba(168,85,247,0.02)');

      if (chartInstance) {
        chartInstance.data.labels = labels;
        chartInstance.data.datasets[0].data = values;
        chartInstance.update();
        return;
      }

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Price (USD)',
            data: values,
            borderColor: '#a855f7',
            borderWidth: 2,
            pointRadius: 0,
            pointHitRadius: 8,
            cubicInterpolationMode: 'monotone',
            tension: 0.3,
            fill: true,
            backgroundColor: gradient
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 600
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.04)' },
              ticks: {
                color: 'rgba(230,240,255,0.7)',
                maxTicksLimit: 6
              }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.04)' },
              ticks: {
                color: 'rgba(230,240,255,0.7)',
                maxTicksLimit: 5
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: '#050509',
              borderColor: 'rgba(255,255,255,0.08)',
              borderWidth: 1,
              titleColor: '#fff',
              bodyColor: '#cfd9ff',
              displayColors: false
            }
          }
        }
      });
    }

    async function loadChart(coinId, symbol, period, { silent = false } = {}) {
      try {
        if (!silent) showLoader(true);
        currentCoin = coinId;
        currentSymbol = symbol;
        setActiveCoinCard(coinId);
        setActivePeriodButton(period);

        const [history, current] = await Promise.all([
          fetchHistory(coinId, period),
          fetchCurrent(coinId)
        ]);

        const labels = history.map(([ts]) => {
          const d = new Date(ts);
          return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        });
        const values = history.map(([, p]) => p);

        createOrUpdateChart(labels, values);

        // Update header stats
        chartTitleEl.textContent = `${symbol} Live Chart`;
        chartSubtitleEl.textContent = `${symbol}/USDT • ${period.toUpperCase()} • Source: CoinGecko`;

        if (current.price != null) {
          chartLastPriceEl.textContent =
            'Current: ' + current.price.toLocaleString(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 6 });
        } else {
          chartLastPriceEl.textContent = 'Current: —';
        }

        if (typeof current.change === 'number') {
          const ch = current.change;
          const cls = ch >= 0 ? 'chart-change-pos' : 'chart-change-neg';
          chartChangeEl.className = cls;
          chartChangeEl.textContent = `24h: ${ch >= 0 ? '+' : ''}${ch.toFixed(2)}%`;
        } else {
          chartChangeEl.className = '';
          chartChangeEl.textContent = '24h: —';
        }
      } catch (err) {
        console.error(err);
        chartSubtitleEl.textContent = 'Failed to load chart. Try again.';
      } finally {
        showLoader(false);
      }
    }

    // Setup events
    document.addEventListener('DOMContentLoaded', () => {
      // Click on card -> load chart
      document.querySelectorAll('.coin-card').forEach(card => {
        card.addEventListener('click', () => {
          const coin = card.dataset.coin;
          const symbol = card.dataset.symbol || coin.toUpperCase();
          loadChart(coin, symbol, currentPeriod);
        });
      });

      // Timeframe buttons
      document.querySelectorAll('.tf-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const period = btn.dataset.period;
          currentPeriod = period;
          const symbol = currentSymbol;
          loadChart(currentCoin, symbol, period);
        });
      });

      // Initial load: BTC 1H
      loadChart('bitcoin', 'BTC', '1h');

      // Auto-refresh current chart every 30 seconds
      setInterval(() => {
        loadChart(currentCoin, currentSymbol, currentPeriod, { silent: true });
      }, 30000);
    });
  </script>
</body>
</html>
