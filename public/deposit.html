<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deposit | GodStake</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: #0b0b0b;
      color: #fff;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 600px;
      margin: 30px auto;
      background: #1a1a1a;
      padding: 30px;
      border-radius: 15px;
      border: 1px solid #333;
    }

    h2 {
      font-size: 1.5rem;
      margin-bottom: 25px;
      color: #a855f7;
    }

    .form-group { margin-bottom: 20px; }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #ccc;
      font-size: 0.95rem;
    }

    select, input {
      width: 100%;
      padding: 12px;
      background: #0b0b0b;
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
      font-size: 1rem;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #a855f7;
    }

    button {
      width: 100%;
      padding: 12px;
      background: #a855f7;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }

    button:hover:not(:disabled) { background: #9333ea; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .error {
      color: #ff6b6b;
      margin-top: 10px;
      padding: 10px;
      background: rgba(255,107,107,0.1);
      border-radius: 8px;
      display: none;
    }

    .payment-section {
      display: none;
      margin-top: 30px;
      padding-top: 30px;
      border-top: 1px solid #333;
    }

    .payment-section.active { display: block; }

    .status-box {
      background: #0b0b0b;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #fbbf24;
    }

    .status-label { font-weight: 600; margin-bottom: 5px; }
    .status-value { color: #fbbf24; font-size: 1.1rem; }
    .status-confirmed .status-value { color: #90ee90; }
    .status-confirmed .status-box { border-left-color: #90ee90; }

    .qr-container { text-align: center; margin: 20px 0; }
    .qr-code { width: 200px; height: 200px; background: #fff; padding: 10px; border-radius: 8px; display: inline-block; }
    .qr-code img { width: 100%; height: 100%; }

    .address-box {
      background: #0b0b0b;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border: 1px solid #333;
      word-break: break-all;
    }

    .copy-btn {
      background: #5eead4;
      color: #000;
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 10px;
    }

    .copy-btn:hover { background: #2dd4bf; }
    .info-text { color: #999; font-size: 0.9rem; margin: 15px 0; line-height: 1.6; }

    .transaction-id {
      background: #0b0b0b;
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 0.85rem;
      word-break: break-all;
    }

    .check-status-btn {
      background: #5eead4;
      color: #000;
      margin-top: 15px;
    }

    .check-status-btn:hover { background: #2dd4bf; }

    .back-link {
      text-align: center;
      margin-top: 20px;
    }

    .back-link a {
      color: #5eead4;
      text-decoration: none;
      font-weight: 600;
    }
  </style>
<link rel="stylesheet" href="/css/premium.css">
</head>
<body>
  <div class="container">
    <h2>üí∞ Make a Deposit</h2>
    
    <form id="depositForm">
      <div class="form-group">
        <label for="coin">Select Cryptocurrency</label>
        <select id="coin" required>
          <option value="">-- Select Coin --</option>
          <option value="BTC">Bitcoin (BTC)</option>
          <option value="ETH">Ethereum (ETH)</option>
          <option value="USDT">Tether USDT</option>
          <option value="BNB">Binance Coin (BNB)</option>
        </select>
      </div>

      <div class="form-group">
        <label for="amount">Amount to Deposit</label>
        <input type="number" id="amount" placeholder="Enter amount" step="0.0001" min="0" required>
      </div>

      <div id="error" class="error"></div>
      <button type="submit" id="submitBtn">Proceed to Payment</button>
    </form>

    <!-- Payment Instructions Section -->
    <div id="paymentSection" class="payment-section">
      <h3 style="color: #a855f7; margin-bottom: 20px;">üìù Payment Instructions</h3>
      
      <div class="status-box" id="statusBox">
        <div class="status-label">Payment Status:</div>
        <div class="status-value" id="statusValue">‚è≥ Waiting for Payment</div>
      </div>

      <div class="info-text">
        <strong>Transaction ID:</strong>
        <div class="transaction-id" id="txId"></div>
      </div>

      <div class="info-text">
        ‚ö†Ô∏è Send exactly <strong id="exactAmount"></strong> <span id="coinSymbol"></span> to the address below.
      </div>

      <div class="qr-container">
        <p style="margin-bottom: 10px; font-weight: 600;">Scan with your wallet:</p>
        <div class="qr-code">
          <img id="qrImage" src="" alt="QR Code">
        </div>
      </div>

      <div>
        <p style="margin-bottom: 10px; font-weight: 600;">Send to this address:</p>
        <div class="address-box" id="addressBox"></div>
        <button type="button" class="copy-btn" onclick="copyAddress()">üìã Copy Address</button>
      </div>

      <button type="button" class="check-status-btn" onclick="checkPaymentStatus()">üîÑ Check Payment Status</button>

      <div id="statusMessage" class="info-text" style="display: none; margin-top: 20px; padding: 15px; background: rgba(144,238,144,0.1); border-radius: 8px; border-left: 3px solid #90ee90;"></div>

      <button type="button" style="background: #5eead4; color: #000; margin-top: 20px;" onclick="goBack()">‚Üê New Deposit</button>
    </div>
  </div>

  <div class="back-link">
    <a href="home.html">‚Üê Back to Dashboard</a>
  </div>

  <script>
    const baseUrl = window.location.origin;

    // üîí Fixed Authentication Check
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        const res = await fetch(`${baseUrl}/api/profile`, {
          method: "GET",
          credentials: "include"
        });

        if (res.status === 401) {
          window.location.href = "login.html";
          return;
        }

        if (!res.ok) {
          console.error("Failed to load profile:", res.status);
          return;
        }

        const data = await res.json();
        console.log("User profile loaded:", data.user);
      } catch (err) {
        console.error("Profile load failed:", err);
        // Optional: only redirect if really unauthenticated
        // window.location.href = "login.html";
      }
    });

    const cryptoData = {
      BTC: { address: 'YOUR_BTC_ADDRESS_HERE', qrCode: `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=bitcoin:YOUR_BTC_ADDRESS_HERE` },
      ETH: { address: 'YOUR_ETH_ADDRESS_HERE', qrCode: `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=ethereum:YOUR_ETH_ADDRESS_HERE` },
      USDT: { address: 'YOUR_USDT_ADDRESS_HERE', qrCode: `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=ethereum:YOUR_USDT_ADDRESS_HERE` },
      BNB: { address: 'YOUR_BNB_ADDRESS_HERE', qrCode: `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=bnb:YOUR_BNB_ADDRESS_HERE` }
    };

    let currentTxId = null, currentCoin = null;

    const form = document.getElementById('depositForm');
    const errorDiv = document.getElementById('error');
    const submitBtn = document.getElementById('submitBtn');
    const paymentSection = document.getElementById('paymentSection');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorDiv.style.display = 'none';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';

      const coin = document.getElementById('coin').value;
      const amount = document.getElementById('amount').value;

      try {
        const res = await fetch(`${baseUrl}/api/deposit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ coin, amount: parseFloat(amount) })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Deposit failed');

        currentTxId = data.txId;
        currentCoin = coin;
        showPaymentDetails(coin, amount);
        form.style.display = 'none';
      } catch (err) {
        errorDiv.textContent = '‚úó ' + err.message;
        errorDiv.style.display = 'block';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Proceed to Payment';
      }
    });

    function showPaymentDetails(coin, amount) {
      const data = cryptoData[coin];
      document.getElementById('exactAmount').textContent = amount;
      document.getElementById('coinSymbol').textContent = coin;
      document.getElementById('addressBox').textContent = data.address;
      document.getElementById('qrImage').src = data.qrCode;
      document.getElementById('txId').textContent = currentTxId;
      paymentSection.classList.add('active');
    }

    async function checkPaymentStatus() {
      try {
        const res = await fetch(`${baseUrl}/api/verify-payment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ txId: currentTxId, coin: currentCoin })
        });

        const data = await res.json();
        const statusBox = document.getElementById('statusBox');
        const statusValue = document.getElementById('statusValue');
        const statusMessage = document.getElementById('statusMessage');

        if (data.status === 'CONFIRMED') {
          statusBox.classList.add('status-confirmed');
          statusValue.textContent = '‚úì Payment Confirmed!';
          statusMessage.innerHTML = `<strong>‚úì Success!</strong> Your deposit of ${data.amount} ${data.coin} has been confirmed.`;
        } else {
          statusValue.textContent = data.status === 'PENDING' ? '‚è≥ Waiting for confirmation...' : '‚ö†Ô∏è Unknown status';
          statusMessage.textContent = data.status === 'PENDING'
            ? 'Still waiting for network confirmation...'
            : 'Payment not found or expired.';
        }

        statusMessage.style.display = 'block';
      } catch (err) {
        alert('Error checking status: ' + err.message);
      }
    }

    function copyAddress() {
      const addr = document.getElementById('addressBox').textContent;
      navigator.clipboard.writeText(addr);
      alert('Address copied!');
    }

    function goBack() {
      paymentSection.classList.remove('active');
      form.style.display = 'block';
      form.reset();
      document.getElementById('statusBox').classList.remove('status-confirmed');
    }
  </script>
</body>
</html>
