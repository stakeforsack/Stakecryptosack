<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deposit — StakCryptoSack</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    :root {
      --bg: #0b0b0b;
      --card: #1a1919;
      --accent: #a855f7;
      --muted: #bbb;
      --error: #ff6b6b;
    }

    body {
      font-family: "Poppins", sans-serif;
      background: var(--bg);
      color: #fff;
      margin: 0;
      min-height: 100vh;
    }

    header { padding: 16px; text-align:center; background: #111; }
    header img { height: 40px; }

    main.center {
      min-height: calc(100vh - 72px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      flex-direction:column;
    }

    h2 { margin-bottom:20px; font-weight:600; }

    .deposit-box {
      width:100%;
      max-width:480px;
      background: var(--card);
      border-radius:12px;
      padding:24px;
      display:flex;
      flex-direction:column;
      gap:14px;
      box-shadow: 0 4px 20px rgba(168,85,247,0.1);
    }

    .coin-list{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      margin-bottom:12px;
    }

    .coin-button{
      padding:10px 14px;
      border-radius:8px;
      border:1px solid #2a2a2a;
      background:#111;
      color:#fff;
      cursor:pointer;
      font-weight:600;
      transition:0.2s all;
    }

    .coin-button:hover { opacity:0.9; }
    .coin-button.selected{
      background: var(--accent);
      border-color: #8b3fe6;
      box-shadow:0 2px 8px rgba(168,85,247,0.2);
    }

    input[type="number"], input[type="text"]{
      padding:12px;
      border-radius:8px;
      border:1px solid #262626;
      background:#111;
      color:#fff;
      font-size:1rem;
    }

    input[type="number"]:focus, input[type="text"]:focus{
      outline:none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }

    .primary-btn{
      background: var(--accent);
      border:none;
      color:#fff;
      padding:12px 0;
      border-radius:8px;
      font-weight:600;
      cursor:pointer;
      transition:0.2s all;
    }

    .primary-btn:hover:not(:disabled) { opacity:0.9; transform: translateY(-1px); }
    .primary-btn:disabled { opacity:0.6; cursor:not-allowed; }

    .error{
      color: var(--error);
      display:none;
      font-weight:500;
    }

    .selected-label{
      color: var(--muted);
      font-size:0.9rem;
      text-align:center;
      margin-bottom:8px;
    }

    .small-note{ color:var(--muted); font-size:0.85rem; text-align:center; }

    .deposit-result {
      margin-top: 16px;
      text-align:center;
    }

    .deposit-result input{
      width:100%;
      max-width:320px;
      text-align:center;
    }

    .deposit-result img{
      display:block;
      margin:10px auto;
      width:200px;
      border-radius:12px;
    }

    /* Page Transition */
    .page-transition-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #0b0b0b;
      z-index: 9999;
      opacity: 1;
      pointer-events: none;
      transition: opacity 0.4s ease;
    }
  </style>
</head>
<body>
  <header>
    <img src="/img/logo.png" alt="Logo">
  </header>

  <main class="center">
    <h2>Select Coin to Deposit</h2>

    <form id="depositForm" class="deposit-box">
      <div class="coin-list" id="coinList">
        <button type="button" class="coin-button selected" data-coin="USDTBINANCE">USDT-BINANCE</button>
        <button type="button" class="coin-button" data-coin="BTC">BTC</button>
        <button type="button" class="coin-button" data-coin="ETH">ETH</button>
        <button type="button" class="coin-button" data-coin="TRX">TRX</button>
        <button type="button" class="coin-button" data-coin="USDTETH">USDT-ETH</button>
        <button type="button" class="coin-button" data-coin="USDTTRON">USDT-TRON</button>
      </div>

      <div class="selected-label">Selected: <strong id="selectedCoinLabel">USDT-BINANCE</strong></div>

      <input id="amount" name="amount" type="number" min="0" step="any" placeholder="Enter amount" />
      <input id="coinInput" name="coin" type="hidden" value="USDTBINANCE" />

      <p class="small-note">Minimum deposit 0</p>

      <button type="submit" id="submitBtn" class="primary-btn">Submit</button>
      <div id="error" class="error"></div>
    </form>

    <div id="depositResult" class="deposit-result" style="display:none;">
      <p>Send the amount to the following address:</p>
      <input id="depositAddress" readonly />
      <img id="depositQRCode" src="" alt="QR Code" />
    </div>

  </main>

  <script src="/js/deposit-submit.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('depositForm');
      const coinInput = document.getElementById('coinInput');
      const amountEl = document.getElementById('amount');
      const submitBtn = document.getElementById('submitBtn');
      const errorEl = document.getElementById('error');
      const selectedLabel = document.getElementById('selectedCoinLabel');
      const coinButtons = document.querySelectorAll('.coin-button');

      const depositResultDiv = document.getElementById('depositResult');
      const depositAddressInput = document.getElementById('depositAddress');
      const depositQRCode = document.getElementById('depositQRCode');

      // Coin selection
      coinButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          coinButtons.forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          coinInput.value = btn.dataset.coin;
          selectedLabel.textContent = btn.textContent;
        });
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        errorEl.style.display = 'none';
        depositResultDiv.style.display = 'none';

        const coin = coinInput.value;
        const amount = amountEl.value.trim();
        if (!amount || Number(amount) <= 0) {
          errorEl.textContent = 'Enter a valid amount';
          errorEl.style.display = 'block';
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating...';

        try {
          const res = await fetch('/deposit', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ coin, amount })
          });

          let payload;
          try {
            payload = await res.json();
          } catch(err){
            const txt = await res.text();
            console.error('Non-JSON response:', res.status, txt);
            errorEl.textContent = `Server returned non-JSON response (status ${res.status})`;
            errorEl.style.display = 'block';
            return;
          }

          if (!res.ok || !payload.ok) {
            errorEl.textContent = payload.error || `Error: ${res.status}`;
            errorEl.style.display = 'block';
            if (res.status === 401) setTimeout(()=> window.location.href='/login.html', 800);
            return;
          }

          // Success — save payload and redirect to result page
          payload.coin = payload.coin || coin;
          payload.address = payload.address || payload.addr || '';
          if (!payload.address) {
            errorEl.textContent = 'Server did not return a deposit address.';
            errorEl.style.display = 'block';
            return;
          }
          try {
            sessionStorage.setItem('lastDeposit', JSON.stringify(payload));
            window.location.href = '/deposit-result.html';
            return;
          } catch (e) {
            // fallback to query params if sessionStorage unavailable
            const q = new URLSearchParams({ coin: payload.coin, address: payload.address }).toString();
            window.location.href = '/deposit-result.html?' + q;
            return;
          }
        } catch(err){
          console.error('Network/fetch error:', err);
          errorEl.textContent = 'Network error — check console';
          errorEl.style.display = 'block';
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit';
        }
      });
    });
  </script>

  <script>
  // Create overlay for page transition
  const createTransitionOverlay = () => {
    let overlay = document.querySelector('.page-transition-overlay');
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.className = 'page-transition-overlay';
      document.body.appendChild(overlay);
    }
    return overlay;
  };

  const overlay = createTransitionOverlay();

  // Fade-in on page load
  window.addEventListener('DOMContentLoaded', () => {
    requestAnimationFrame(() => {
      overlay.style.opacity = '0';
      setTimeout(() => overlay.remove(), 500);
    });
  });

  // Fade-out on link click
  document.querySelectorAll('a[href]').forEach(link => {
    if (!link.href.startsWith(window.location.origin)) return;

    link.addEventListener('click', e => {
      e.preventDefault();
      const href = link.href;

      const newOverlay = createTransitionOverlay();
      newOverlay.style.opacity = '0';
      newOverlay.style.pointerEvents = 'auto';
      document.body.appendChild(newOverlay);

      requestAnimationFrame(() => {
        newOverlay.style.opacity = '1';
      });

      setTimeout(() => {
        window.location.href = href;
      }, 400);
    });
  });

  // Handle back/forward navigation
  window.addEventListener('pageshow', event => {
    if (event.persisted) {
      const newOverlay = createTransitionOverlay();
      requestAnimationFrame(() => {
        newOverlay.style.opacity = '0';
        setTimeout(() => newOverlay.remove(), 500);
      });
    }
  });
</script>
</body>
</html>
