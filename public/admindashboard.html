<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CryptoYieldPro Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#07070a; --card:#0f0f12; --muted:#9aa3b2; --accent:#a855f7; --accent2:#5eead4;
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#050507 0%, #0b0b0b 100%);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;color:#e6eef8}
  .wrap{max-width:1200px;margin:28px auto;padding:20px;}
  .top{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .logo{font-weight:700;font-size:20px;color:var(--accent)}
  .keyBox{display:flex;gap:8px;align-items:center}
  input.input{background:#0a0a0c;border:1px solid rgba(255,255,255,0.04);padding:10px 12px;border-radius:8px;color:#fff;outline:none}
  button.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;padding:10px 14px;border-radius:8px;color:#021;cursor:pointer;font-weight:600}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:18px;margin-top:18px}
  .left{display:grid;gap:18px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);padding:14px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  h3{margin:0 0 10px 0;color:#fff}
  .list{max-height:320px;overflow:auto;padding:8px;display:block;gap:8px}
  .item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;background:var(--glass);border:1px solid rgba(255,255,255,0.02);margin-bottom:8px}
  .small{font-size:13px;color:var(--muted)}
  .muted{color:var(--muted)}
  .actions{display:flex;gap:8px}
  .btn-approve{background:linear-gradient(90deg,#22c55e,#16a34a);color:#021;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn-decline{background:#ff5c5c;color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
  .user-row{cursor:pointer}
  .right .card{position:sticky;top:20px}
  .tx-list{max-height:240px;overflow:auto;padding:8px}
  pre { background:#06060a;color:#cfe8ff;padding:10px;border-radius:8px;white-space:pre-wrap;font-size:13px }
  .signinOverlay{position:fixed;left:0;top:0;right:0;bottom:0;background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.7));display:flex;align-items:center;justify-content:center;z-index:999}
  .signinCard{background:#07070b;padding:26px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);width:420px;box-shadow:0 20px 60px rgba(0,0,0,0.7);text-align:center}
  .logoLarge{font-size:18px;color:var(--accent);font-weight:700;margin-bottom:6px}
  .hint{color:var(--muted);font-size:13px;margin-bottom:14px}
  .footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
  .badge { padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.03);font-weight:700; color:var(--muted); font-size:13px }
  .meta { font-size:13px; color:var(--muted) }
  .pill { padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px }
  .pill.pending { background:#1f2937; color:#fbbf24 }
  .pill.confirmed { background:#052e11; color:#7ef6b8 }
  .pill.declined { background:#2b0f0f; color:#ff8b8b }
  @media (max-width:980px){ .grid{grid-template-columns:1fr} .right{order:-1} .card{padding:12px} }
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="logo">CryptoYieldPro â€¢ Admin Dashboard</div>
    <div class="keyBox">
      <input id="adminKeyShow" class="input" placeholder="Enter admin key (optional)"/>
      <button id="openSign" class="btn">Sign-in</button>
    </div>
  </div>

  <div style="height:14px"></div>

  <div class="grid">
    <div class="left">
      <div class="card">
        <h3>Pending Deposits</h3>
        <div id="pendingDeposits" class="list"><div class="small muted">Loading...</div></div>
      </div>

      <div class="card">
        <h3>Pending Withdrawals</h3>
        <div id="pendingWithdraws" class="list"><div class="small muted">Loading...</div></div>
      </div>

      <div class="card">
        <h3>All Users</h3>
        <div id="usersList" class="list"><div class="small muted">Loading...</div></div>
      </div>
    </div>

    <div class="right">
      <div class="card">
        <h3>Actions & Transaction Viewer</h3>

        <div style="display:flex;gap:8px;margin-bottom:10px">
          <input id="txInspect" class="input" placeholder="Enter txId or userId to inspect" />
          <button id="btnInspect" class="btn">Inspect</button>
          <button id="btnRefresh" class="btn" style="background:linear-gradient(90deg,var(--accent2),var(--accent))">Refresh</button>
        </div>

        <div style="display:flex;gap:8px;margin-bottom:10px">
          <div style="flex:1">
            <input id="approveTxInput" class="input" placeholder="txId to approve" />
            <button id="approveTxBtn" class="btn-approve" style="width:100%;margin-top:8px">Approve</button>
          </div>
          <div style="flex:1">
            <input id="declineTxInput" class="input" placeholder="txId to decline" />
            <button id="declineTxBtn" class="btn-decline" style="width:100%;margin-top:8px">Decline</button>
          </div>
        </div>

        <h3 style="margin-top:10px">Recent Transactions</h3>
        <div id="recentTx" class="tx-list small"><div class="small muted">Loading...</div></div>
      </div>

      <div class="card" style="margin-top:18px">
        <h3>User Transaction History / Inspect</h3>
        <pre id="userTxHistory">Select a user to view transaction history or inspect txId/userId above.</pre>
      </div>
    </div>
  </div>

  <div class="footer">CryptoYieldPro â€¢ Admin â€¢ Signed in as <span id="adminLabel">â€”</span></div>
</div>

<!-- Sign-in overlay -->
<div id="signin" class="signinOverlay" style="display:flex">
  <div class="signinCard">
    <div class="logoLarge">CryptoYieldPro Admin Sign-in</div>
    <div class="hint">Enter your Admin Key to unlock the dashboard</div>
    <input id="signinKey" class="input" placeholder="Admin Key" style="width:100%;margin-bottom:12px"/>
    <div style="display:flex;gap:8px;justify-content:center">
      <button id="signinBtn" class="btn">Sign in</button>
      <button id="cancelBtn" class="btn" style="background:#2b2b2b;color:#fff">Cancel</button>
    </div>
    <div style="height:8px"></div>
    <div class="small muted">Admin key not stored â€” used for this session only.</div>
  </div>
</div>

<script>
/*
  Merged Admin Dashboard JS
  Endpoints expected on backend:
    GET  /api/admin/pending-deposits
    GET  /api/admin/pending-withdraws
    GET  /api/admin/users
    GET  /api/admin/all-transactions
    POST /api/admin/approve-deposit   { txId }
    POST /api/admin/approve-withdraw  { txId, tx_hash? }
    POST /api/admin/decline-transaction { txId }
    GET  /api/admin/user-transactions/:userId
    (and /api/cron/payouts is available for scheduled runs)
*/

let ADMIN_KEY = "";          // stored in memory for this session (not saved)
const $ = id => document.getElementById(id);

// helper wrapper for admin calls
async function callAdmin(path, method='GET', body=null) {
  if (!ADMIN_KEY) {
    alert("Admin key not set. Sign in first.");
    return null;
  }
  const opts = { method, headers: { 'Content-Type': 'application/json', 'x-admin-key': ADMIN_KEY } };
  if (body) opts.body = JSON.stringify(body);
  try {
    const res = await fetch(path, opts);
    const text = await res.text();
    try { return JSON.parse(text); } catch (e) { return text; }
  } catch (err) {
    console.error("callAdmin error", err);
    alert("Network error: " + err.message);
    return null;
  }
}

// render helpers
function elItem(title, subtitle, rightHtml='') {
  return `<div class="item"><div>
            <div class="user-row"><strong>${title}</strong></div>
            <div class="small muted">${subtitle}</div>
          </div>
          <div class="actions">${rightHtml}</div></div>`;
}

// load pending deposits (shows membership flag)
async function loadPendingDeposits(){
  const res = await callAdmin('/api/admin/pending-deposits');
  const wrap = $('pendingDeposits');
  wrap.innerHTML = '';
  if (!res || !res.pending) { wrap.innerHTML = '<div class="small muted">No data or unauthorized</div>'; return; }
  res.pending.forEach(tx=>{
    const isMembership = tx.meta && tx.meta.isMembership;
    const memBadge = isMembership ? `<div class="small muted" style="margin-bottom:6px">ðŸ”° Membership: ${tx.meta.membershipTier || 'â€”'}</div>` : '';
    const right = `<div style="text-align:right">
                    <div style="font-weight:700">${tx.amount} ${tx.coin}</div>
                    <div style="height:8px"></div>
                    <button class="btn-approve" onclick="approveTx('${tx._id}')">Approve</button>
                    <button class="btn-decline" onclick="declineTx('${tx._id}')">Decline</button>
                    <div class="small muted" style="margin-top:6px">User: ${tx.userId?.username || tx.userId}</div>
                   </div>`;
    wrap.insertAdjacentHTML('beforeend', `<div style="margin-bottom:8px">${memBadge}${elItem('Deposit: '+tx._id, `User: ${tx.userId?.username || 'N/A'} â€¢ ${new Date(tx.createdAt).toLocaleString()}`, right)}</div>`);
  });
}

// load pending withdraws
async function loadPendingWithdraws(){
  const res = await callAdmin('/api/admin/pending-withdraws');
  const wrap = $('pendingWithdraws');
  wrap.innerHTML = '';
  if (!res || !res.pending) { wrap.innerHTML = '<div class="small muted">No data or unauthorized</div>'; return; }
  res.pending.forEach(tx=>{
    const right = `<div style="text-align:right">
                    <div style="font-weight:700">${tx.amount} ${tx.coin}</div>
                    <div style="height:8px"></div>
                    <button class="btn-approve" onclick="approveTx('${tx._id}', true)">Approve</button>
                    <button class="btn-decline" onclick="declineTx('${tx._id}')">Decline</button>
                    <div class="small muted" style="margin-top:6px">User: ${tx.userId?.username || tx.userId}</div>
                   </div>`;
    wrap.insertAdjacentHTML('beforeend', elItem('Withdraw: '+tx._id, `User: ${tx.userId?.username || 'N/A'} â€¢ ${new Date(tx.createdAt).toLocaleString()}`, right));
  });
}

// load users
async function loadUsers(){
  const res = await callAdmin('/api/admin/users');
  const wrap = $('usersList');
  wrap.innerHTML = '';
  if (!res || !res.users) { wrap.innerHTML = '<div class="small muted">No data or unauthorized</div>'; return; }
  res.users.forEach(u=>{
    const right = `<div style="text-align:right">
                    <div style="font-weight:700">${(u.balance||0).toFixed(2)} USD</div>
                    <div style="height:8px"></div>
                    <button class="btn" onclick="inspectUser('${u._id}')">View TX</button>
                  </div>`;
    wrap.insertAdjacentHTML('beforeend', elItem(u.username+' â€¢ '+ (u.email || ''), `Created: ${new Date(u.createdAt).toLocaleString()}`, right));
  });
}

// load recent transactions
async function loadRecentTx(){
  const res = await callAdmin('/api/admin/all-transactions');
  const wrap = $('recentTx');
  wrap.innerHTML = '';
  if (!res || !res.tx) { wrap.innerHTML = '<div class="small muted">No transactions or unauthorized</div>'; return; }
  const list = res.tx.slice(0, 100);
  list.forEach(t=>{
    const status = t.status || 'PENDING';
    const badgeClass = status === 'CONFIRMED' ? 'pill confirmed' : status === 'DECLINED' ? 'pill declined' : 'pill pending';
    const row = `<div style="padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);">
                  <div style="display:flex;justify-content:space-between;align-items:center">
                    <div><strong>${t.type}</strong> â€¢ ${t.coin} â€¢ ${t.amount}</div>
                    <div class="${badgeClass}">${status}</div>
                  </div>
                  <div class="small muted">User: ${t.userId?.username || t.userId} â€¢ ${new Date(t.createdAt).toLocaleString()}</div>
                 </div>`;
    wrap.insertAdjacentHTML('beforeend', row);
  });
}

// approve tx (deposit or withdraw). If isWithdraw param true -> call approve-withdraw
async function approveTx(txId, isWithdraw=false){
  if (!confirm("Approve transaction " + txId + " ?")) return;
  try {
    if (isWithdraw) {
      const tx_hash = prompt("Enter blockchain tx hash (optional)","");
      const res = await callAdmin('/api/admin/approve-withdraw','POST',{ txId, tx_hash });
      alert(res && res.ok ? 'Withdraw approved' : JSON.stringify(res));
    } else {
      const res = await callAdmin('/api/admin/approve-deposit','POST',{ txId });
      alert(res && res.ok ? 'Deposit approved' : JSON.stringify(res));
    }
  } catch (err) {
    alert('Error approving: ' + err.message);
  }
  refreshAll();
}

// decline tx
async function declineTx(txId){
  if (!confirm("Decline transaction " + txId + " ?")) return;
  const res = await callAdmin('/api/admin/decline-transaction','POST',{ txId });
  alert(res && res.ok ? 'Transaction declined' : JSON.stringify(res));
  refreshAll();
}

// inspect user's transactions
async function inspectUser(userId){
  const res = await callAdmin('/api/admin/user-transactions/'+userId);
  if (!res) return;
  $('userTxHistory').innerText = JSON.stringify(res, null, 2);
}

// generic inspect (tx or user)
document.getElementById('btnInspect').onclick = async ()=>{
  const v = $('txInspect').value.trim();
  if (!v) return alert('Enter txId or userId');
  // try get all tx and find id quickly
  const all = await callAdmin('/api/admin/all-transactions');
  if (all && all.tx){
    const found = all.tx.find(t => t._id === v || t._id == v);
    if (found) { $('userTxHistory').innerText = JSON.stringify(found, null, 2); return; }
  }
  // fallback: user transactions
  const userRes = await callAdmin('/api/admin/user-transactions/'+v);
  $('userTxHistory').innerText = JSON.stringify(userRes, null, 2);
};

// refresh all panels
async function refreshAll(){
  await Promise.all([loadPendingDeposits(), loadPendingWithdraws(), loadUsers(), loadRecentTx()]);
}

// wire buttons
document.getElementById('btnRefresh').onclick = refreshAll;
document.getElementById('approveTxBtn').onclick = async ()=>{
  const txId = $('approveTxInput').value.trim();
  if (!txId) return alert('Enter txId');
  // try to detect if tx is withdraw by fetching all tx
  const all = await callAdmin('/api/admin/all-transactions');
  if (all && all.tx){
    const found = all.tx.find(t => t._id === txId || t._id == txId);
    if (found && found.type === 'WITHDRAW') { await approveTx(txId, true); return; }
  }
  await approveTx(txId, false);
};
document.getElementById('declineTxBtn').onclick = async ()=>{
  const txId = $('declineTxInput').value.trim();
  if (!txId) return alert('Enter txId');
  await declineTx(txId);
};

// SIGN IN / overlay
document.getElementById('signinBtn').onclick = ()=>{
  const k = $('signinKey').value.trim();
  if (!k) return alert('Enter admin key');
  ADMIN_KEY = k;
  $('adminLabel').innerText = 'Admin (session)';
  $('adminKeyShow').value = '(session key)';
  document.getElementById('signin').style.display = 'none';
  refreshAll();
};
document.getElementById('cancelBtn').onclick = ()=>{ document.getElementById('signin').style.display = 'none'; };
document.getElementById('openSign').onclick = ()=>{
  const k = $('adminKeyShow').value.trim();
  if (k) { $('signinKey').value = k; }
  document.getElementById('signin').style.display = 'flex';
};
// auto-open if adminKeyShow prefilled
if ($('adminKeyShow').value.trim()) document.getElementById('openSign').click();

// initial load (but require sign-in)
(function init(){
  // If adminKeyShow has something prefilled, use it
  if ($('adminKeyShow').value.trim()) {
    ADMIN_KEY = $('adminKeyShow').value.trim();
    $('adminLabel').innerText = 'Admin (session)';
    document.getElementById('signin').style.display = 'none';
    refreshAll();
  } else {
    // show overlay
    document.getElementById('signin').style.display = 'flex';
  }
})();
</script>
</body>
</html>
